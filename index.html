<!DOCTYPE html>
<html lang="pt-BR">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunControl | Troca de Plantão</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="icon" type="image/png" href="https://i.postimg.cc/V6HS85m6/SUN-CONTROL-removebg.png">

    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #f0f0f0; overflow-x: hidden; }
        :root { --sun-yellow: #FFC700; }

        .btn { transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease; border: none; cursor: pointer; }
        .btn:hover { transform: scale(1.03); }
        .btn:disabled { background-color: #333; color: #777; cursor: not-allowed; transform: none; }
        .btn-primary { background-color: var(--sun-yellow); color: #111; }
        .btn-primary:not(:disabled):hover { box-shadow: 0 0 20px rgba(255, 199, 0, 0.4); }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-secondary { background-color: #374151; color: white; }

        .glassmorphism { background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .form-input, .form-select { background-color: #1a1a1a; border: 1px solid #333; color: #f0f0f0; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--sun-yellow); box-shadow: 0 0 10px rgba(255, 199, 0, 0.3); }
        .form-input:read-only { background-color: #222; opacity: 0.7; cursor: not-allowed; }
        .form-select option { background-color: #1a1a1a; color: #f0f0f0 !important; }

        .shift-card { background-color: #1c1c1c; border-left-width: 4px; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .shift-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        
        .status-aguardando { border-color: #f59e0b; } .status-confirmada { border-color: #3b82f6; }
        .status-aprovada { border-color: #22c55e; } .status-recusada { border-color: #ef4444; }
        .status-expirada { border-color: #6b7280; } /* Cor para status Expirada */

        .blob { position: fixed; border-radius: 50%; mix-blend-mode: screen; filter: blur(70px); z-index: -1; opacity: 0.32; }
        @keyframes pulse-blob { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.2) rotate(180deg); } }
        .animate-pulse-blob { animation: pulse-blob 20s infinite ease-in-out; }

        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-close { color: #f0f0f0 !important; transition: color 0.2s ease-in-out; }
        .modal-close:hover { color: var(--sun-yellow); }
        .clickable-name { cursor: pointer; text-decoration: underline; text-decoration-color: rgba(255, 199, 0, 0.5); transition: text-decoration-color 0.3s; }
        .clickable-name:hover { text-decoration-color: rgba(255, 199, 0, 1); }
        .verified-badge { color: #1DA1F2; font-size: 0.8em; vertical-align: middle; margin-left: 0.25rem; }

        /* Estilos para Notificações */
        .notification-item { transition: background-color 0.2s; }
        .notification-item.unread { background-color: rgba(255, 199, 0, 0.1); }
        .notification-item:not(:last-child) { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }

        /* ===== NOVOS ESTILOS PARA O DASHBOARD ===== */
        :root {
            --color-approved: #22c55e;
            --color-pending: #f59e0b;
            --color-rejected: #ef4444;
        }

        .stat-card {
            border-left-width: 4px;
            animation: slideUpFadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        .progress-bar-bg {
            background-color: #374151;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 1s ease-out;
            width: 0%; /* Inicia com 0 para animar */
        }
        
        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Fundo animado -->
    <div class="blob bg-yellow-400 w-96 h-96 top-10 left-10 animate-pulse-blob"></div>
    <div class="blob bg-blue-500 w-96 h-96 bottom-10 right-10 animate-pulse-blob" style="animation-delay: 7s;"></div>

    <!-- ===== TELA DE AUTENTICAÇÃO ===== -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Formulário de Login -->
            <div id="login-view">
                <div class="glassmorphism p-8 rounded-2xl">
                    <h2 class="text-3xl font-bold text-center text-white mb-2">Bem-vindo ao <span class="text-blue-500">SunControl</span></h2>
                    <p class="text-center text-gray-400 mb-8">Acesse para gerenciar os plantões.</p>
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="Email" required class="form-input w-full p-3 rounded-lg" autocomplete="email">
                        <input type="password" id="login-password" placeholder="Senha" required class="form-input w-full p-3 rounded-lg" autocomplete="current-password">
                        <button type="submit" class="btn btn-primary w-full font-bold py-3 rounded-full text-base">Entrar</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
                    <p class="text-center text-sm text-gray-400 mt-6">Não tem uma conta? <a href="#" id="show-register" class="font-semibold text-[var(--sun-yellow)] hover:underline">Cadastre-se</a></p>
                </div>
            </div>

            <!-- Formulário de Cadastro -->
            <div id="register-view" class="hidden">
                 <div class="glassmorphism p-8 rounded-2xl">
                    <h2 class="text-3xl font-bold text-center text-white mb-2">Crie sua Conta</h2>
                    <p class="text-center text-gray-400 mb-8">O acesso será validado por um supervisor.</p>
                    <form id="register-form" class="space-y-4">
                        <input type="text" id="register-name" placeholder="Nome Completo" required class="form-input w-full p-3 rounded-lg" autocomplete="name">
                        <input type="email" id="register-email" placeholder="Email" required class="form-input w-full p-3 rounded-lg" autocomplete="email">
                        <input type="password" id="register-password" placeholder="Senha (mínimo 6 caracteres)" required class="form-input w-full p-3 rounded-lg" autocomplete="new-password">
                        <input type="password" id="register-confirm-password" placeholder="Confirmar Senha" required class="form-input w-full p-3 rounded-lg" autocomplete="new-password">
                        <button type="submit" class="btn btn-primary w-full font-bold py-3 rounded-full text-base">Cadastrar</button>
                    </form>
                    <p id="register-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
                    <p class="text-center text-sm text-gray-400 mt-6">Já tem uma conta? <a href="#" id="show-login" class="font-semibold text-[var(--sun-yellow)] hover:underline">Faça Login</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== APLICAÇÃO PRINCIPAL (escondida por padrão) ===== -->
    <div id="app-container" class="hidden">
        <header class="fixed top-0 left-0 w-full z-50 py-3 px-6 md:px-12 glassmorphism">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fa-solid fa-shield-halved text-[var(--sun-yellow)]"></i>
                    <h1 class="text-xl font-bold text-white">SunControl</h1>
                </div>
                <div class="flex items-center space-x-4">
                     <div id="supervisor-actions" class="hidden">
                         <button id="open-dashboard-btn" class="btn btn-secondary text-xs font-semibold py-2 px-3 rounded-full flex items-center gap-2">
                             <i class="fa-solid fa-table-columns"></i> Dashboard
                         </button>
                     </div>
                     <!-- Ícone de Notificação -->
                     <div id="notification-bell" class="relative cursor-pointer p-2 rounded-full hover:bg-white/10 transition-colors">
                        <i class="fa-solid fa-bell text-white text-lg"></i>
                        <span id="notification-badge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center font-bold"></span>
                     </div>
                     <div id="profile-area" class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-white/10 transition-colors">
                         <img id="profile-pic-header" src="https://placehold.co/40x40/1a1a1a/f0f0f0?text=S" class="w-8 h-8 rounded-full object-cover border-2 border-gray-600">
                         <div class="text-right">
                             <span id="user-greeting" class="text-sm font-semibold text-white block"></span>
                             <span id="user-role" class="text-xs text-[var(--sun-yellow)] block capitalize"></span>
                         </div>
                     </div>
                     <button id="logout-btn" class="btn btn-danger text-xs font-semibold py-2 px-3 rounded-full">Sair</button>
                </div>
            </div>
        </header>

        <main class="pt-24 pb-12 relative z-10">
            <!-- Seção de estatísticas (oculta para 'dono') -->
            <section id="dashboard-stats" class="container mx-auto px-6 md:px-12 mb-12 hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="glassmorphism p-4 rounded-lg"><h4 class="text-2xl font-bold text-[var(--sun-yellow)]" id="count-total">0</h4><p class="text-sm text-gray-400">Total</p></div>
                    <div class="glassmorphism p-4 rounded-lg"><h4 class="text-2xl font-bold text-yellow-500" id="count-pending">0</h4><p class="text-sm text-gray-400">Aguardando</p></div>
                    <div class="glassmorphism p-4 rounded-lg"><h4 class="text-2xl font-bold text-green-500" id="count-approved">0</h4><p class="text-sm text-gray-400">Aprovadas</p></div>
                    <div class="glassmorphism p-4 rounded-lg"><h4 class="text-2xl font-bold text-red-500" id="count-rejected">0</h4><p class="text-sm text-gray-400">Recusadas</p></div>
                </div>
            </section>

            <div id="main-content-grid" class="container mx-auto px-6 md:px-12 grid lg:grid-cols-3 gap-8">
                <div id="form-section" class="lg:col-span-1"></div>
                <div id="shift-list-container" class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">Histórico de Trocas</h3>
                        <div id="export-container" class="flex space-x-3">
                            <!-- Botões de exportar e excluir tudo para o dono -->
                        </div>
                    </div>
                    <div id="shift-list" class="space-y-4"></div>
                </div>
            </div>
        </main>
        <!-- FOOTER -->
        <footer class="py-6 px-6 md:px-12 text-center text-gray-400 text-sm">
            Desenvolvido por <a href="https://www.linkedin.com/in/jordan-luiz-3ab157363?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app" target="_blank" class="font-bold text-white hover:underline whitespace-nowrap">@jordanlvs <i class="fa-solid fa-circle-check verified-badge"></i></a> (Proprietário da <a href="https://www.instagram.com/weblv.dev/" target="_blank" class="font-bold text-white hover:underline">WebLv)</a>        
        </footer>
    </div>
    
    <!-- ===== MODAIS ===== -->
    <div id="modal-container"></div>

    <!-- Firebase SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <!-- Lógica da Aplicação -->
    <script type="module">
        // --- SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, serverTimestamp, getDoc, setDoc, getDocs, where, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0UFqsNRUGVwDpYcwduab8WaxoVrMxiBA",
            authDomain: "suncontrol-d2d94.firebaseapp.com",
            projectId: "suncontrol-d2d94",
            storageBucket: "suncontrol-d2d94.appspot.com",
            messagingSenderId: "434845455719",
            appId: "1:434845455719:web:06cb665d1274c973f4cbc2"
        };
        
        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const modalContainer = document.getElementById('modal-container');
        
        // --- APP STATE ---
        let currentUserProfile = null;
        let allShifts = [];
        let allUsers = new Map();
        let userNotifications = [];
        let statusChart = null;
        let monthlyChart = null;
        let unsubscribeListeners = []; // Array para guardar todos os listeners

        // --- TEMPLATES HTML ---
        const confirmationModalHTML = (title, message, confirmClass) => `
            <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 opacity-0">
                <div class="modal-content glassmorphism rounded-2xl p-8 max-w-sm w-full shadow-lg scale-95 opacity-0">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-xl font-bold">${title}</h4>
                        <button class="modal-close p-2 rounded-full hover:bg-white/10">
                            <i class="fa-solid fa-xmark w-5 h-5 text-white"></i>
                        </button>
                    </div>
                    <p class="text-gray-300 mb-8">${message}</p>
                    <div class="flex justify-end space-x-4">
                        <button class="modal-close btn btn-secondary font-semibold py-2 px-5 rounded-full">Cancelar</button>
                        <button id="modalConfirm" class="btn ${confirmClass} font-semibold py-2 px-5 rounded-full">Confirmar</button>
                    </div>
                </div>
            </div>`;

        const profileModalHTML = (user, isOwnProfile) => {
            const photo = user.photoURL || `https://placehold.co/80x80/1a1a1a/f0f0f0?text=${user.name.charAt(0)}`;
            const posto = user.posto || 'Não informado';
            const cidade = user.cidade || 'Não informado';
            
            return `
            <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 opacity-0">
                <div class="modal-content glassmorphism rounded-2xl p-8 max-w-lg w-full shadow-lg scale-95 opacity-0">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">${isOwnProfile ? 'Meu Perfil' : `Perfil de ${user.name.split(' ')[0]}`}</h3>
                        <button class="modal-close p-2 rounded-full hover:bg-white/10">
                           <i class="fa-solid fa-xmark w-5 h-5 text-white"></i>
                        </button>
                    </div>
                    <div id="profile-view-mode">
                        <div class="space-y-4">
                            <div class="flex items-center space-x-4">
                                <img src="${photo}" class="w-20 h-20 rounded-full object-cover border-2 border-[var(--sun-yellow)]">
                                <h4 class="text-2xl font-bold">${user.name}</h4>
                            </div>
                            <p><strong class="text-gray-400 w-20 inline-block">Posto:</strong> ${posto}</p>
                            <p><strong class="text-gray-400 w-20 inline-block">Cidade:</strong> ${cidade}</p>
                            ${isOwnProfile ? '<div class="pt-4 flex justify-end"><button id="edit-profile-btn" class="btn btn-secondary font-bold py-2 px-6 rounded-full text-base">Editar Perfil</button></div>' : ''}
                        </div>
                    </div>
                    <form id="profile-edit-mode" class="hidden space-y-4">
                        <div class="flex items-center space-x-4">
                            <img src="${photo}" id="edit-profile-pic-preview" class="w-20 h-20 rounded-full object-cover border-2 border-[var(--sun-yellow)]">
                            <div class="flex-grow">
                                <label class="text-sm font-medium text-gray-300">URL da Foto de Perfil</label>
                                <input type="url" id="profile-photo-url" value="${user.photoURL || ''}" placeholder="https://exemplo.com/sua-foto.jpg" class="form-input w-full p-3 rounded-lg mt-1">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-300">Posto de Trabalho</label>
                            <input type="text" id="profile-posto" value="${user.posto || ''}" placeholder="Ex: Portaria Principal" class="form-input w-full p-3 rounded-lg mt-1">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-300">Cidade</label>
                            <input type="text" id="profile-cidade" value="${user.cidade || ''}" placeholder="Ex: São Paulo" class="form-input w-full p-3 rounded-lg mt-1" ${user.cidade ? 'readonly' : ''}>
                        </div>
                        <details class="pt-2">
                            <summary class="text-sm text-gray-400 cursor-pointer hover:text-white">Como adicionar minha foto de perfil?</summary>
                            <p class="text-xs text-gray-500 mt-2 p-3 bg-black/20 rounded-lg">Para adicionar uma foto, você precisa hospedá-la em um site (como <a href="https://imgur.com/upload" target="_blank" class="underline">Imgur</a>). Após o upload, clique com o botão direito na imagem, selecione "Copiar endereço da imagem" e cole o link no campo acima.</p>
                        </details>
                        <div class="pt-4 flex justify-end space-x-4">
                            <button type="button" id="cancel-edit-btn" class="btn btn-secondary font-bold py-3 px-8 rounded-full text-base">Cancelar</button>
                            <button type="submit" class="btn btn-primary font-bold py-3 px-8 rounded-full text-base">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>`;
        };

const dashboardModalHTML = () => `
    <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 opacity-0">
        <div class="modal-content glassmorphism rounded-2xl p-6 md:p-8 max-w-4xl w-full shadow-lg scale-95 opacity-0 flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h3 class="text-2xl font-bold">Dashboard de Ocorrências</h3>
                <button class="modal-close p-2 rounded-full hover:bg-white/10">
                    <i class="fa-solid fa-xmark w-5 h-5 text-white"></i>
                </button>
            </div>

            <div class="flex-grow overflow-y-auto pr-4 -mr-4">
                <!-- Grid de Estatísticas Principais -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="stat-card bg-gray-800/50 p-4 rounded-lg border-l-[var(--sun-yellow)]" style="animation-delay: 0s;">
                        <div class="flex items-center text-gray-400 text-sm font-medium"><i class="fa-solid fa-layer-group mr-2"></i> Total</div>
                        <div id="db-total-count" class="text-3xl font-bold mt-1 text-white">0</div>
                    </div>
                    <div class="stat-card bg-gray-800/50 p-4 rounded-lg border-l-[var(--color-approved)]" style="animation-delay: 0.1s;">
                        <i class="fa-solid fa-circle-check mr-2 text-[var(--color-approved)] !text-[var(--color-approved)]"></i>
                        <div id="db-approved-count" class="text-3xl font-bold mt-1 text-white">0</div>
                    </div>
                    <div class="stat-card bg-gray-800/50 p-4 rounded-lg border-l-[var(--color-pending)]" style="animation-delay: 0.2s;">
                        <div class="flex items-center text-gray-400 text-sm font-medium"><i class="fa-solid fa-clock mr-2 text-[var(--color-pending)]"></i> Pendentes</div>
                        <div id="db-pending-count" class="text-3xl font-bold mt-1 text-white">0</div>
                    </div>
                    <div class="stat-card bg-gray-800/50 p-4 rounded-lg border-l-[var(--color-rejected)]" style="animation-delay: 0.3s;">
                        <div class="flex items-center text-gray-400 text-sm font-medium"><i class="fa-solid fa-circle-xmark mr-2 text-[var(--color-rejected)]"></i> Recusadas</div>
                        <div id="db-rejected-count" class="text-3xl font-bold mt-1 text-white">0</div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Detalhes por Status -->
                    <div>
                        <h4 class="font-bold text-lg mb-4">Detalhes por Status</h4>
                        <div id="status-details-list" class="space-y-4">
                            <!-- Conteúdo gerado por JS -->
                        </div>
                    </div>
                    <!-- Trocas por Mês -->
                    <div>
                        <h4 class="font-bold text-lg mb-4">Trocas por Mês</h4>
                        <div id="monthly-stats-list" class="space-y-3">
                            <!-- Conteúdo gerado por JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;

        
        const notificationModalHTML = () => `
            <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 opacity-0">
                <div class="modal-content glassmorphism rounded-2xl p-8 max-w-lg w-full shadow-lg scale-95 opacity-0 flex flex-col" style="max-height: 90vh;">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h3 class="text-2xl font-bold">Notificações</h3>
                        <button class="modal-close p-2 rounded-full hover:bg-white/10">
                            <i class="fa-solid fa-xmark w-5 h-5 text-white"></i>
                        </button>
                    </div>
                    <div id="notification-list" class="flex-grow overflow-y-auto -mr-4 pr-4 space-y-2">
                        <!-- Itens de notificação serão inseridos aqui -->
                    </div>
                    <div id="notification-actions" class="mt-6 flex-shrink-0">
                       <!-- Ações como "Marcar todas como lidas" serão inseridas aqui -->
                    </div>
                </div>
            </div>`;

        const shiftFormHTML = `
            <div class="glassmorphism p-6 rounded-2xl sticky top-24">
                <h3 class="text-2xl font-bold mb-6">Solicitar Troca</h3>
                <form id="shift-form-inner" class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-gray-300">Trocar com o(a) colega</label>
                        <select id="colleagueName" required class="form-select w-full p-3 rounded-lg mt-1">
                            <option value="" disabled selected>Selecione um colega</option>
                        </select>
                        <div id="selected-colleague-preview" class="hidden mt-3 p-3 bg-white/5 rounded-lg border border-white/10 flex items-center space-x-3">
                        </div>
                    </div>
                    <div>
                         <label class="text-sm font-medium text-gray-300">Seu plantão atual (que você quer trocar)</label>
                        <input type="datetime-local" id="originalDate" required class="form-input w-full p-3 rounded-lg mt-1">
                    </div>
                    <div>
                         <label class="text-sm font-medium text-gray-300">Plantão desejado (que você quer pegar)</label>
                        <input type="datetime-local" id="desiredDate" required class="form-input w-full p-3 rounded-lg mt-1">
                    </div>
                    <div>
                         <label class="text-sm font-medium text-gray-300">Motivo (opcional)</label>
                        <textarea id="reason" placeholder="Ex: Consulta médica" rows="3" class="form-input w-full p-3 rounded-lg mt-1"></textarea>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="btn btn-primary w-full font-bold py-3 px-8 rounded-full text-base">Enviar Solicitação</button>
                    </div>
                </form>
            </div>`;

        // --- AUTHENTICATION LOGIC ---
        function initializeAuth() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');

            onAuthStateChanged(auth, (user) => {
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    
                    const unsub = onSnapshot(userDocRef, (doc) => {
                        if (doc.exists()) {
                            const newProfile = { uid: user.uid, ...doc.data() };
                            
                            if (JSON.stringify(newProfile) !== JSON.stringify(currentUserProfile)) {
                                currentUserProfile = newProfile;
                                initializeAppUI();
                            } else {
                            }
                        } else {
                            console.error('[DEBUG] ERRO: Documento do usuário não encontrado no Firestore!');
                            signOut(auth);
                        }
                    }, (error) => {
                        console.error("[DEBUG] ERRO CRÍTICO no listener do perfil (verifique as REGRAS do Firestore):", error);
                        signOut(auth);
                    });
                    
                    unsubscribeListeners.push(unsub);
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');

                } else {
                    currentUserProfile = null;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorP = document.getElementById('login-error');
                errorP.textContent = '';
                try { await signInWithEmailAndPassword(auth, email, password); } 
                catch (error) { errorP.textContent = "Email ou senha inválidos."; }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const errorP = document.getElementById('register-error');
                errorP.textContent = '';

                if (password !== confirmPassword) { errorP.textContent = 'As senhas não coincidem.'; return; }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { name, email, role: 'vigilante', posto: '', cidade: '', photoURL: '' });
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') errorP.textContent = 'Este email já está em uso.';
                    else if (error.code === 'auth/weak-password') errorP.textContent = 'A senha deve ter no mínimo 6 caracteres.';
                    else errorP.textContent = 'Ocorreu um erro ao cadastrar.';
                }
            });

            showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); });
        }
        
        // --- MAIN APP LOGIC ---
        async function initializeAppUI() {
            if (!currentUserProfile) {
                console.error('[DEBUG] initializeAppUI chamada sem currentUserProfile!');
                return;
            }
            
            const { name, role, photoURL } = currentUserProfile;
            document.getElementById('user-greeting').textContent = `Olá, ${name.split(' ')[0]}`;
            document.getElementById('user-role').textContent = role;
            document.getElementById('profile-pic-header').src = photoURL || `https://placehold.co/40x40/1a1a1a/f0f0f0?text=${name.charAt(0)}`;

            const formSection = document.getElementById('form-section');
            const shiftListContainer = document.getElementById('shift-list-container');
            const supervisorActions = document.getElementById('supervisor-actions');
            const dashboardStats = document.getElementById('dashboard-stats');

            if (role === 'supervisor' || role === 'dono') {
                formSection.innerHTML = '';
                formSection.style.display = 'none';
                shiftListContainer.classList.remove('lg:col-span-2');
                shiftListContainer.classList.add('lg:col-span-3');
                supervisorActions.classList.remove('hidden');
                dashboardStats.classList.remove('hidden');
            } else {
                formSection.innerHTML = shiftFormHTML;
                formSection.style.display = 'block';
                shiftListContainer.classList.remove('lg:col-span-3');
                shiftListContainer.classList.add('lg:col-span-2');
                supervisorActions.classList.add('hidden');
                dashboardStats.classList.remove('hidden');
            }
            
            await fetchAllUsers();
            setupEventListeners();
            startRealtimeListeners();
        }

        async function fetchAllUsers() {
            allUsers.clear();
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                querySnapshot.forEach(doc => allUsers.set(doc.id, { id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Erro ao buscar usuários (verifique as regras do Firestore):", error);
            }
            
            const colleaguesSelect = document.getElementById('colleagueName');
            if (colleaguesSelect) {
                colleaguesSelect.innerHTML = '<option value="" disabled selected>Selecione um colega</option>';
                allUsers.forEach(user => {
                    if (user.id !== currentUserProfile.uid && user.role === 'vigilante') {
                        const option = document.createElement('option');
                        option.value = user.name;
                        option.textContent = user.name;
                        option.dataset.uid = user.id;
                        colleaguesSelect.appendChild(option);
                    }
                });
            }
        }

        function startRealtimeListeners() {
            unsubscribeListeners.filter(unsub => unsub.type === 'data').forEach(unsub => unsub.func());
            unsubscribeListeners = unsubscribeListeners.filter(unsub => unsub.type !== 'data');

            const shiftsCollectionRef = collection(db, "shifts");
            const qShifts = query(shiftsCollectionRef, orderBy('createdAt', 'desc'));
            const unsubShifts = onSnapshot(qShifts, (snapshot) => {
                allShifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderShifts();
            }, (error) => {
                console.error("Erro no listener de trocas:", error);
            });
            unsubscribeListeners.push({type: 'data', func: unsubShifts});

            if (!currentUserProfile) return;
            const qNotif = query(
                collection(db, "notifications"),
                where("userId", "==", currentUserProfile.uid),
                orderBy("createdAt", "desc")
            );

            const unsubNotif = onSnapshot(qNotif, (snapshot) => {
                userNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const unreadCount = userNotifications.filter(n => !n.read).length;
                const badge = document.getElementById('notification-badge');

                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }, (error) => {
                 console.error("Erro no listener de notificações:", error);
            });
            unsubscribeListeners.push({type: 'data', func: unsubNotif});
        }

        function renderShifts() {
            if (!currentUserProfile) return;
            const shiftList = document.getElementById('shift-list');
            shiftList.innerHTML = '';
            
            const isSupervisor = currentUserProfile.role === 'supervisor';
            const isDono = currentUserProfile.role === 'dono';

            const visibleShifts = isSupervisor || isDono ? allShifts : allShifts.filter(s => s.requesterUid === currentUserProfile.uid || s.colleagueUid === currentUserProfile.uid);

            if (visibleShifts.length === 0) {
                shiftList.innerHTML = `<div class="text-center text-gray-500 p-8 bg-[#1a1a1a]/50 rounded-lg">Nenhuma solicitação para você.</div>`;
            } else {
                visibleShifts.forEach(shift => {
                    const statusMap = { 
                        'Aguardando Confirmação': { class: 'status-aguardando', text: 'Aguardando Confirmação', icon: 'fa-solid fa-clock', iconColor: 'text-yellow-500' }, 
                        'Confirmada - Aguardando Supervisor': { class: 'status-confirmada', text: 'Aguardando Supervisor', icon: 'fa-solid fa-user-check', iconColor: 'text-green-500' }, 
                        'Aprovada': { class: 'status-aprovada', text: 'Aprovada', icon: 'fa-solid fa-circle-check', iconColor: 'text-green-500' }, 
                        'Recusada': { class: 'status-recusada', text: 'Recusada pelo Colega', icon: 'fa-solid fa-circle-xmark', iconColor: 'text-red-500' }, 
                        'Recusada pelo Supervisor': { class: 'status-recusada', text: 'Recusada pelo Supervisor', icon: 'fa-solid fa-shield-xmark', iconColor: 'text-red-600' }, 
                        'Expirada': { class: 'status-expirada', text: 'Expirada', icon: 'fa-solid fa-calendar-xmark', iconColor: 'text-red-400' }, 
                    };

                    const now = new Date();
                    const originalDate = new Date(shift.originalDate);
                    const desiredDate = new Date(shift.desiredDate);
                    let currentStatus = shift.status;

                    if (currentStatus === 'Aguardando Confirmação' && now > originalDate && now > desiredDate) {
                        currentStatus = 'Expirada';
                    }

                    const statusInfo = statusMap[currentStatus];
                    const card = document.createElement('div');
                    card.className = `shift-card p-5 rounded-lg ${statusInfo.class}`;
                    card.id = `shift-${shift.id}`;

                    let actionsHtml = '';
                    if (currentUserProfile.uid === shift.colleagueUid && currentStatus === 'Aguardando Confirmação') {
                        actionsHtml = `<button data-id="${shift.id}" data-action="accept" class="btn btn-success text-xs font-bold py-2 px-4 rounded-full">Aceitar</button> <button data-id="${shift.id}" data-action="reject" class="btn btn-danger text-xs font-bold py-2 px-4 rounded-full">Recusar</button>`;
                    }
                    if ((isSupervisor || isDono) && currentStatus === 'Confirmada - Aguardando Supervisor') {
                         actionsHtml = `<button data-id="${shift.id}" data-action="approve" class="btn btn-success text-xs font-bold py-2 px-4 rounded-full">Aprovar</button> <button data-id="${shift.id}" data-action="decline" class="btn btn-danger text-xs font-bold py-2 px-4 rounded-full">Recusar</button>`;
                    }
                    if (isDono) {
                        actionsHtml += `<button data-id="${shift.id}" data-action="delete-shift" class="btn btn-danger text-xs font-bold py-2 px-4 rounded-full ml-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>`;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-start flex-wrap gap-2">
                            <div>
                                <h4 class="font-bold text-lg text-white">
                                    <span class="clickable-name" data-uid="${shift.requesterUid}">${shift.requester}</span> 
                                    <i class="fa-solid fa-arrow-right-long text-gray-400 inline-block h-4 w-4 mx-2"></i>
                                    <span class="clickable-name" data-uid="${shift.colleagueUid}">${shift.colleague}</span>
                                </h4>
                                <p class="text-sm text-gray-400">De: ${formatDateTime(shift.originalDate)} <br> Para: ${formatDateTime(shift.desiredDate)}</p>
                                ${shift.reason ? `<p class="text-sm text-gray-300 mt-2 italic">Motivo: "${shift.reason}"</p>` : ''}
                            </div>
                            <div class="text-right flex-shrink-0"><span class="flex items-center justify-end text-sm font-semibold"><i class="${statusInfo.icon} ${statusInfo.iconColor} h-4 w-4 mr-2"></i> ${statusInfo.text}</span></div>
                        </div>
                        ${actionsHtml ? `<div class="mt-4 pt-4 border-t border-gray-700 flex justify-end space-x-3">${actionsHtml}</div>` : ''}
                    `;
                    shiftList.appendChild(card);
                });
            }
            updateDashboardStats();
        }
        
        function updateDashboardStats() {
            const dashboardStats = document.getElementById('dashboard-stats');
            if (dashboardStats.classList.contains('hidden')) return;

            const counts = allShifts.reduce((acc, shift) => {
                const status = shift.status;
                if (status === 'Aguardando Confirmação' || status === 'Confirmada - Aguardando Supervisor') {
                    acc.pending++;
                } else if (status === 'Aprovada') {
                    acc.approved++;
                } else if (status === 'Recusada' || status === 'Recusada pelo Supervisor') {
                    acc.rejected++;
                }
                return acc;
            }, { pending: 0, approved: 0, rejected: 0 });

            document.getElementById('count-total').textContent = allShifts.length;
            document.getElementById('count-pending').textContent = counts.pending;
            document.getElementById('count-approved').textContent = counts.approved;
            document.getElementById('count-rejected').textContent = counts.rejected;

            const exportContainer = document.getElementById('export-container');
            if (currentUserProfile && currentUserProfile.role === 'dono') {
                exportContainer.innerHTML = `
                    <button id="delete-all-shifts-btn" class="btn btn-danger text-xs font-semibold py-2 px-3 rounded-full">Excluir Todas</button>
                    <button id="export-json" class="btn btn-secondary text-xs font-semibold py-2 px-3 rounded-full">Exportar JSON</button>
                `;
                document.getElementById('export-json').addEventListener('click', exportDataAsJson);
                document.getElementById('delete-all-shifts-btn').addEventListener('click', () => {
                    showActionModal('Excluir Todas as Trocas', 'Tem certeza que deseja EXCLUIR TODAS as trocas? Esta ação é irreversível.', 'btn-danger', deleteAllShifts);
                });
            } else if (currentUserProfile && currentUserProfile.role === 'supervisor') {
                exportContainer.innerHTML = `<button id="export-json" class="btn btn-secondary text-xs font-semibold py-2 px-3 rounded-full">Exportar JSON</button>`;
                document.getElementById('export-json').addEventListener('click', exportDataAsJson);
            } else {
                exportContainer.innerHTML = '';
            }
        }

        async function createNotification(userId, message, shiftId = null) {
            try {
                const notificationData = {
                    userId,
                    message,
                    shiftId,
                    read: false,
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, "notifications"), notificationData);
            } catch(error) {
                console.error("Erro ao criar notificação:", error);
            }
        }

        function handleLogout() { signOut(auth); }
        function handleProfileClick() { openProfileModal(currentUserProfile, true); }
        function handleOpenDashboard() { openDashboardModal(); }
        function handleOpenNotifications() { openNotificationsModal(); }

        async function handleShiftFormSubmit(e) {
            e.preventDefault();
            const colleagueSelect = document.getElementById('colleagueName');
            const selectedOption = colleagueSelect.options[colleagueSelect.selectedIndex];
            const colleagueName = selectedOption.value;
            const colleagueUid = selectedOption.dataset.uid;

            if (!colleagueUid) { alert('Por favor, selecione um colega válido da lista.'); return; }
            
            const newShiftData = {
                requester: currentUserProfile.name, requesterUid: currentUserProfile.uid,
                colleague: colleagueName, colleagueUid: colleagueUid,
                originalDate: document.getElementById('originalDate').value,
                desiredDate: document.getElementById('desiredDate').value,
                reason: document.getElementById('reason').value,
                status: 'Aguardando Confirmação',
                createdAt: serverTimestamp()
            };
            
            const docRef = await addDoc(collection(db, "shifts"), newShiftData);
            
            const notificationMessage = `${currentUserProfile.name} enviou uma solicitação de troca.`;
            await createNotification(colleagueUid, notificationMessage, docRef.id);

            e.target.reset();
            document.getElementById('selected-colleague-preview').classList.add('hidden');
            document.getElementById('selected-colleague-preview').innerHTML = '';
        }

        function handleShiftListClick(e) {
            const nameSpan = e.target.closest('.clickable-name');
            const actionButton = e.target.closest('button');

            if (nameSpan) {
                const uid = nameSpan.dataset.uid;
                const userToView = allUsers.get(uid);
                if (userToView) openProfileModal(userToView, uid === currentUserProfile.uid);
                return;
            }

            if (actionButton) {
                const id = actionButton.dataset.id;
                const action = actionButton.dataset.action;
                const shift = allShifts.find(s => s.id === id);
                if (!shift) return;

                const performUpdate = async (newStatus) => {
                    await updateDoc(doc(db, "shifts", id), { status: newStatus });
                    
                    const supervisors = Array.from(allUsers.values()).filter(u => u.role === 'supervisor' || u.role === 'dono');
                    switch (newStatus) {
                        case 'Confirmada - Aguardando Supervisor':
                            await createNotification(shift.requesterUid, `${shift.colleague} aceitou sua solicitação de troca.`, shift.id);
                            supervisors.forEach(sup => createNotification(sup.id, `A troca entre ${shift.requester} e ${shift.colleague} aguarda aprovação.`, shift.id));
                            break;
                        case 'Recusada':
                            await createNotification(shift.requesterUid, `${shift.colleague} recusou sua solicitação de troca.`, shift.id);
                            break;
                        case 'Aprovada':
                            await createNotification(shift.requesterUid, `Sua troca com ${shift.colleague} foi APROVADA.`, shift.id);
                            await createNotification(shift.colleagueUid, `Sua troca com ${shift.requester} foi APROVADA.`, shift.id);
                            break;
                        case 'Recusada pelo Supervisor':
                            await createNotification(shift.requesterUid, `Sua troca com ${shift.colleague} foi RECUSADA pelo supervisor.`, shift.id);
                            await createNotification(shift.colleagueUid, `Sua troca com ${shift.requester} foi RECUSADA pelo supervisor.`, shift.id);
                            break;
                    }
                };

                const actions = {
                    accept: () => showActionModal('Aceitar Troca', `Confirma a troca do plantão?`, 'btn-success', () => performUpdate('Confirmada - Aguardando Supervisor')),
                    reject: () => showActionModal('Recusar Troca', 'Tem certeza que deseja recusar?', 'btn-danger', () => performUpdate('Recusada')),
                    approve: () => showActionModal('Aprovar Troca', 'Confirma a aprovação final?', 'btn-success', () => performUpdate('Aprovada')),
                    decline: () => showActionModal('Recusar Troca', 'Tem certeza que deseja recusar?', 'btn-danger', () => performUpdate('Recusada pelo Supervisor')),
                    'delete-shift': () => showActionModal('Excluir Troca', 'Tem certeza que deseja excluir esta troca?', 'btn-danger', () => deleteShift(id))
                };
                if (actions[action]) actions[action]();
            }
        }

        function handleColleagueSelectChange() {
            const colleagueSelect = document.getElementById('colleagueName');
            const previewContainer = document.getElementById('selected-colleague-preview');
            
            if (!colleagueSelect || !previewContainer || !colleagueSelect.value || colleagueSelect.selectedIndex === 0) {
                if(previewContainer) {
                    previewContainer.classList.add('hidden');
                    previewContainer.innerHTML = '';
                }
                return;
            }

            const selectedOption = colleagueSelect.options[colleagueSelect.selectedIndex];
            const selectedColleagueUid = selectedOption.dataset.uid;

            if (selectedColleagueUid) {
                const selectedColleague = allUsers.get(selectedColleagueUid);
                if (selectedColleague) {
                    const photo = selectedColleague.photoURL || `https://placehold.co/40x40/1a1a1a/f0f0f0?text=${selectedColleague.name.charAt(0)}`;
                    const posto = selectedColleague.posto || 'Não informado';
                    const cidade = selectedColleague.cidade || 'Não informado';
                    previewContainer.innerHTML = `<img src="${photo}" class="w-10 h-10 rounded-full object-cover border border-white/20"><div><p class="font-bold text-white">${selectedColleague.name}</p><p class="text-xs text-gray-400">Posto: ${posto}</p><p class="text-xs text-gray-400">Cidade: ${cidade}</p></div>`;
                    previewContainer.classList.remove('hidden');
                } else {
                    previewContainer.classList.add('hidden');
                }
            } else {
                previewContainer.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('profile-area')?.addEventListener('click', handleProfileClick);
            document.getElementById('open-dashboard-btn')?.addEventListener('click', handleOpenDashboard);
            document.getElementById('notification-bell')?.addEventListener('click', handleOpenNotifications);
            document.getElementById('shift-list')?.addEventListener('click', handleShiftListClick);

            const shiftFormContainer = document.getElementById('form-section');
            if(shiftFormContainer.hasChildNodes()) {
                const shiftFormInner = shiftFormContainer.querySelector('#shift-form-inner');
                const colleagueNameSelect = document.getElementById('colleagueName');
                shiftFormInner?.addEventListener('submit', handleShiftFormSubmit);
                colleagueNameSelect?.addEventListener('change', handleColleagueSelectChange);
            }
        }

        function openProfileModal(user, isOwnProfile) {
            const modalEl = createAndAppendModal(profileModalHTML(user, isOwnProfile));
            if (!modalEl) return;
            if (isOwnProfile) {
                const viewMode = modalEl.querySelector('#profile-view-mode');
                const editMode = modalEl.querySelector('#profile-edit-mode');
                const handleEditProfileClick = () => { viewMode.classList.add('hidden'); editMode.classList.remove('hidden'); };
                const handleCancelEditClick = () => { viewMode.classList.remove('hidden'); editMode.classList.add('hidden'); };
                const handleProfileEditSubmit = (e) => saveProfileData(e, modalEl);
                modalEl.querySelector('#edit-profile-btn')?.addEventListener('click', handleEditProfileClick);
                modalEl.querySelector('#cancel-edit-btn')?.addEventListener('click', handleCancelEditClick);
                editMode?.addEventListener('submit', handleProfileEditSubmit);
            }
        }

        async function saveProfileData(e, modalEl) {
            e.preventDefault();
            const photoURL = document.getElementById('profile-photo-url').value;
            const posto = document.getElementById('profile-posto').value;
            const cidade = document.getElementById('profile-cidade').value;
            if (!currentUserProfile || !currentUserProfile.uid) return;
            
            const dataToUpdate = { photoURL, posto };
            if (!currentUserProfile.cidade && cidade) dataToUpdate.cidade = cidade;
            
            const userDocRef = doc(db, "users", currentUserProfile.uid);
            try {
                await updateDoc(userDocRef, dataToUpdate);
                hideModalContainer(modalEl);
                // Não precisa de reload, o onSnapshot cuidará da atualização.
            } catch (error) {
                console.error("Erro ao salvar perfil:", error);
            }
        }

function openDashboardModal() {
    // Remove as variáveis antigas dos gráficos, se existirem
    statusChart = null;
    monthlyChart = null;

    const modalEl = createAndAppendModal(dashboardModalHTML());
    if (!modalEl) return;

    // --- Lógica de Animação e Cálculo ---
    const animateCountUp = (el, endValue) => {
        let startValue = 0;
        const duration = 1000; // 1 segundo
        const startTime = performance.now();

        function step(currentTime) {
            const elapsedTime = currentTime - startTime;
            const progress = Math.min(elapsedTime / duration, 1);
            el.textContent = Math.floor(progress * endValue).toLocaleString('pt-BR');
            if (progress < 1) {
                requestAnimationFrame(step);
            } else {
                el.textContent = endValue.toLocaleString('pt-BR');
            }
        }
        requestAnimationFrame(step);
    };

    // 1. Calcular todos os dados
    const counts = allShifts.reduce((acc, shift) => {
        const status = shift.status;
        if (status === 'Aguardando Confirmação' || status === 'Confirmada - Aguardando Supervisor') acc.pending++;
        else if (status === 'Aprovada') acc.approved++;
        else if (status.startsWith('Recusada')) acc.rejected++;
        return acc;
    }, { pending: 0, approved: 0, rejected: 0 });
    counts.total = allShifts.length;

    const statusDetails = allShifts.reduce((acc, s) => {
        acc[s.status] = (acc[s.status] || 0) + 1;
        return acc;
    }, {});

    const monthlyCounts = allShifts.reduce((acc, s) => {
        if (s.createdAt?.toDate) {
            const month = s.createdAt.toDate().toLocaleString('pt-BR', { month: 'long' });
            const year = s.createdAt.toDate().getFullYear();
            const key = `${month.charAt(0).toUpperCase() + month.slice(1)} de ${year}`;
            acc[key] = (acc[key] || 0) + 1;
        }
        return acc;
    }, {});

    // 2. Animar os cards principais
    animateCountUp(modalEl.querySelector('#db-total-count'), counts.total);
    animateCountUp(modalEl.querySelector('#db-approved-count'), counts.approved);
    animateCountUp(modalEl.querySelector('#db-pending-count'), counts.pending);
    animateCountUp(modalEl.querySelector('#db-rejected-count'), counts.rejected);

    // 3. Renderizar detalhes de status com barras de progresso
    const statusListEl = modalEl.querySelector('#status-details-list');
    statusListEl.innerHTML = '';
    const statusColors = { 'Aprovada': 'var(--color-approved)', 'Recusada': 'var(--color-rejected)', 'Aguardando': 'var(--color-pending)' };

    Object.entries(statusDetails).forEach(([status, count]) => {
        const percentage = counts.total > 0 ? (count / counts.total * 100).toFixed(1) : 0;
        const colorKey = Object.keys(statusColors).find(key => status.includes(key)) || 'var(--sun-yellow)';

        const itemHtml = `
            <div>
                <div class="flex justify-between items-center mb-1 text-sm">
                    <span class="font-semibold text-gray-300">${status}</span>
                    <span class="text-gray-400">${count} (${percentage}%)</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="background-color: ${statusColors[colorKey] || '#6b7280'};" data-width="${percentage}%"></div>
                </div>
            </div>`;
        statusListEl.insertAdjacentHTML('beforeend', itemHtml);
    });

    // Ativa a animação da barra de progresso após um pequeno delay
    setTimeout(() => {
        modalEl.querySelectorAll('.progress-bar-fill').forEach(bar => {
            bar.style.width = bar.dataset.width;
        });
    }, 100);

    // 4. Renderizar lista de trocas por mês
    const monthlyListEl = modalEl.querySelector('#monthly-stats-list');
    monthlyListEl.innerHTML = '';
    if (Object.keys(monthlyCounts).length > 0) {
        Object.entries(monthlyCounts).forEach(([month, count]) => {
            const itemHtml = `
                <div class="flex justify-between items-center text-sm p-2 rounded-md hover:bg-white/5">
                    <span class="text-gray-300">${month}</span>
                    <span class="font-bold text-white bg-gray-700 px-2 py-0.5 rounded-md">${count} trocas</span>
                </div>`;
            monthlyListEl.insertAdjacentHTML('beforeend', itemHtml);
        });
    } else {
        monthlyListEl.innerHTML = `<p class="text-center text-gray-500 text-sm">Nenhum dado mensal.</p>`;
    }
}


        function openNotificationsModal() {
            const modalEl = createAndAppendModal(notificationModalHTML());
            if (!modalEl) return;

            const notificationList = modalEl.querySelector('#notification-list');
            const notificationActions = modalEl.querySelector('#notification-actions');
            
            if (userNotifications.length === 0) {
                notificationList.innerHTML = `<p class="text-center text-gray-400 p-8">Nenhuma notificação encontrada.</p>`;
                return;
            }

            userNotifications.forEach(n => {
                const item = document.createElement('div');
                item.className = `notification-item p-4 rounded-lg cursor-pointer ${!n.read ? 'unread' : 'bg-white/5'}`;
                item.innerHTML = `
                    <p class="text-white">${n.message}</p>
                    <p class="text-xs text-gray-400 mt-1">${formatRelativeTime(n.createdAt)}</p>
                `;
                item.addEventListener('click', async () => {
                    await markNotificationAsRead(n.id);
                    if (n.shiftId) {
                        hideModalContainer(modalEl);
                        const shiftCard = document.getElementById(`shift-${n.shiftId}`);
                        shiftCard?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        shiftCard?.classList.add('animate-pulse');
                        setTimeout(() => shiftCard?.classList.remove('animate-pulse'), 2000);
                    }
                });
                notificationList.appendChild(item);
            });
            
            const unreadCount = userNotifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                const markAllReadBtn = document.createElement('button');
                markAllReadBtn.className = 'btn btn-secondary w-full font-semibold py-2 rounded-full';
                markAllReadBtn.textContent = 'Marcar todas como lidas';
                markAllReadBtn.addEventListener('click', async () => {
                    await markAllNotificationsAsRead();
                    modalEl.querySelectorAll('.notification-item.unread').forEach(item => {
                        item.classList.remove('unread');
                        item.classList.add('bg-white/5');
                    });
                    markAllReadBtn.remove();
                });
                notificationActions.appendChild(markAllReadBtn);
            }
        }

        async function markNotificationAsRead(notificationId) {
            const notificationRef = doc(db, "notifications", notificationId);
            await updateDoc(notificationRef, { read: true });
        }

        async function markAllNotificationsAsRead() {
            const unread = userNotifications.filter(n => !n.read);
            if (unread.length === 0) return;

            const batch = writeBatch(db);
            unread.forEach(n => {
                const notificationRef = doc(db, "notifications", n.id);
                batch.update(notificationRef, { read: true });
            });
            await batch.commit();
        }
        
        function createAndAppendModal(innerHTML) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = innerHTML.trim();
            const modalEl = tempDiv.firstElementChild;
            if (!modalEl) return null;
            modalContainer.appendChild(modalEl);
            modalEl.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => hideModalContainer(modalEl)));
            modalEl.addEventListener('click', (e) => { if (e.target === modalEl) hideModalContainer(modalEl); });
            showModalContainer(modalEl);
            return modalEl;
        }

        function showActionModal(title, message, confirmClass, onConfirm) {
            const modalEl = createAndAppendModal(confirmationModalHTML(title, message, confirmClass));
            if (!modalEl) return;
            modalEl.querySelector('#modalConfirm').addEventListener('click', () => { onConfirm(); hideModalContainer(modalEl); });
        }

        function showModalContainer(modalEl) {
            if (!modalEl) return;
            setTimeout(() => {
                modalEl.classList.remove('opacity-0');
                const content = modalEl.querySelector('.modal-content');
                content?.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideModalContainer(modalEl) {
            if (!modalEl) return;
            modalEl.classList.add('opacity-0');
            const content = modalEl.querySelector('.modal-content');
            content?.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { if(modalContainer.contains(modalEl)) modalContainer.removeChild(modalEl); }, 300);
        }
        
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = typeof dateTimeString.toDate === 'function' ? dateTimeString.toDate() : new Date(dateTimeString);
            return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function formatRelativeTime(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') return '';
            const date = timestamp.toDate();
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 60) return `há ${seconds} segundos`;
            if (minutes < 60) return `há ${minutes} minutos`;
            if (hours < 24) return `há ${hours} horas`;
            return `há ${days} dias`;
        }

        function exportDataAsJson() {
            const dataToExport = allShifts.map(s => ({...s, createdAt: s.createdAt.toDate()}));
            const jsonContent = JSON.stringify(dataToExport, null, 2);
            const a = document.createElement('a');
            const blob = new Blob([jsonContent], { type: 'application/json' });
            a.href = URL.createObjectURL(blob);
            a.download = 'suncontrol_trocas.json';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        async function deleteShift(shiftId) {
            try {
                await deleteDoc(doc(db, "shifts", shiftId));
            } catch (error) {
                console.error("Erro ao excluir troca:", error);
            }
        }

        async function deleteAllShifts() {
            try {
                const shiftsRef = collection(db, "shifts");
                const querySnapshot = await getDocs(shiftsRef);
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => batch.delete(doc.ref));
                await batch.commit();
            } catch (error) {
                console.error("Erro ao excluir todas as trocas:", error);
            }
        }

        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', initializeAuth);
    </script>
</body>
</html>
